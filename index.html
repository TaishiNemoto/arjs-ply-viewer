<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AR.js PLY Diagnostic v2</title>

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    #hud{
      position:fixed; left:10px; top:10px; z-index:99999;
      padding:10px 12px; border-radius:10px;
      background:rgba(0,0,0,.65); color:#fff;
      font:13px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
      max-width:92vw; white-space:pre-wrap;
    }
  </style>

  <script>
    // HUDが無いタイミングでもログを溜める
    const __logs = [];
    function log(msg){
      __logs.push(msg);
      const hud = document.getElementById("hud");
      if (hud) hud.textContent = __logs.join("\n");
    }
    window.addEventListener("error", (e) => log("JSエラー: " + (e.message || "unknown")));
    window.addEventListener("unhandledrejection", (e) => log("Promiseエラー: " + (e.reason?.message || e.reason || "unknown")));
    document.addEventListener("DOMContentLoaded", () => log("DOM loaded"));
    setTimeout(() => log("5秒経過"), 5000);
  </script>

  <script
    src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"
    onload="log('A-Frame loaded')"
    onerror="log('A-Frame load failed')"
  ></script>

  <script
    src="https://unpkg.com/ar.js@3.4.5/aframe/build/aframe-ar.js"
    onload="log('AR.js loaded')"
    onerror="log('AR.js load failed')"
  ></script>

  <script
    src="https://unpkg.com/three@0.152.2/examples/js/loaders/PLYLoader.js"
    onload="log('PLYLoader loaded')"
    onerror="log('PLYLoader load failed')"
  ></script>

  <script>
    log("inline script running");

    function boot(){
      if (!window.AFRAME) { log("AFRAME missing"); return; }
      log("AFRAME detected");

      AFRAME.registerComponent("ply-pointcloud", {
        schema: { src:{type:"string",default:"./web-model.ply"} },
        init(){
          log("component init");
          if (!window.THREE) { log("THREE missing"); return; }
          if (!THREE.PLYLoader) { log("PLYLoader missing"); return; }

          log("start PLY load: " + this.data.src);
          const loader = new THREE.PLYLoader();
          loader.load(
            this.data.src,
            (g) => log("PLY loaded vertices=" + (g?.attributes?.position?.count ?? "unknown")),
            undefined,
            (err) => log("PLY load error: " + (err?.message || err || "unknown"))
          );
        }
      });
      log("component registered");
    }

    // AFRAMEが来たら起動
    const t = setInterval(() => {
      if (window.AFRAME) { clearInterval(t); boot(); }
    }, 100);
  </script>
</head>

<body>
  <div id="hud">起動中…</div>

  <a-scene embedded vr-mode-ui="enabled:false" arjs="sourceType: webcam; debugUIEnabled:false;">
    <a-marker type="pattern" url="./default-marker.patt">
      <a-entity ply-pointcloud="src: ./web-model.ply"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>




